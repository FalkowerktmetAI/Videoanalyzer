<!--
  Title: AI-Powered Frame Analyzer (5s + Emotion + Purpose) ‚Äî Blue UI
  Author: ChatGPT (Falko - AI & Design)
  Notes: Single-file app. Only external dependency is Tailwind CDN.
  GENERATED_BY: PROMPT2.1
-->
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI-Videoanalyse ‚Äî Emotie & Doel (5s)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    .scroll-shadow { mask-image: linear-gradient(to bottom, transparent, black 12px, black calc(100% - 12px), transparent); }
    .mono { font-variant-ligatures: none; }
    .visually-hidden { position:absolute; left:-9999px; }
  </style>
</head>
<body class="bg-blue-50 text-slate-900 antialiased">
  <div class="mx-auto max-w-6xl px-4 py-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-blue-700 tracking-tight">
        üé• AI-Videoanalyse <span class="text-blue-400 text-lg align-middle">Emotie & Doel</span>
      </h1>
      <p class="text-slate-600 mt-1">Upload een video en laat AI elke <strong>5 seconden</strong> een frame analyseren:
        beschrijving, zichtbare emotie(s) en het <em>doel</em> van het shot.</p>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-5 items-start">
      <!-- LEFT: Inputs + Player + Log -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Inputs -->
        <div class="bg-white rounded-2xl shadow-sm ring-1 ring-blue-200 p-4">
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Videobestand</label>
              <input id="fileInput" type="file" accept="video/*" class="w-full rounded-xl border-blue-300 text-sm focus:ring-2 focus:ring-blue-600"/>
              <p class="text-xs text-slate-500 mt-1">Korte clips werken het snelst.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-blue-700 mb-1">Gemini API key</label>
              <input id="apiKeyInput" type="password" placeholder="AIza..." class="w-full rounded-xl border-blue-300 text-sm focus:ring-2 focus:ring-blue-600" />
              <p class="text-xs text-slate-500 mt-1">Slechts in geheugen; niet opgeslagen.</p>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-3">
            <button id="analyzeBtn" disabled class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-sm font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
              Start Analyse (5s)
            </button>
            <button id="stopBtn" disabled class="inline-flex items-center gap-2 rounded-xl bg-rose-600 px-4 py-2 text-sm font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-rose-700">
              Stop
            </button>

            <span id="statusPill" class="inline-flex items-center rounded-full bg-blue-100 text-blue-800 px-2.5 py-1 text-xs font-medium">
              Status: <strong class="ml-1 font-semibold" id="statusText">ready</strong>
            </span>
            <span class="text-xs text-slate-500">Stap: <span id="stepText" class="font-medium">‚Äì</span></span>
            <span class="text-xs text-slate-500">Voortgang: <span id="progressText" class="font-medium">0%</span></span>
          </div>

          <!-- Progress bar -->
          <div class="mt-3 h-2 w-full rounded-full bg-blue-100 overflow-hidden">
            <div id="progressBar" class="h-full w-0 bg-blue-600 transition-[width] duration-300"></div>
          </div>

          <p class="mt-3 text-xs text-slate-500">
            Emotie wordt alleen gerapporteerd bij duidelijke gezichtsuitdrukkingen. Geen identificatie of gevoelige attributen.
          </p>
        </div>

        <!-- Player -->
        <div class="bg-white rounded-2xl shadow-sm ring-1 ring-blue-200 overflow-hidden">
          <div class="aspect-video bg-blue-100">
            <video id="videoEl" class="w-full h-full" controls playsinline preload="metadata" hidden></video>
            <canvas id="captureCanvas" class="visually-hidden"></canvas>
          </div>
          <div class="px-4 py-3 border-t border-blue-100 text-sm text-slate-600 flex flex-wrap gap-x-4 gap-y-1">
            <span>Duur: <span id="metaDuration">‚Äì</span></span>
            <span>Grootte: <span id="metaSize">‚Äì</span></span>
            <span>Type: <span id="metaType">‚Äì</span></span>
            <span>Resolutie: <span id="metaRes">‚Äì</span></span>
          </div>
        </div>

        <!-- Debug Log -->
        <div class="bg-white rounded-2xl shadow-sm ring-1 ring-blue-200">
          <div class="px-4 py-3 border-b border-blue-100 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-blue-700">Debug Log</h2>
            <div class="flex items-center gap-2">
              <button id="copyLogBtn" class="text-xs px-2.5 py-1 rounded-lg bg-blue-50 hover:bg-blue-100">Copy</button>
              <button id="clearLogBtn" class="text-xs px-2.5 py-1 rounded-lg bg-blue-50 hover:bg-blue-100">Clear</button>
            </div>
          </div>
          <div id="logArea" class="p-3 max-h-56 overflow-auto mono text-xs leading-relaxed whitespace-pre-wrap scroll-shadow"></div>
        </div>
      </div>

      <!-- RIGHT: Results -->
      <div class="bg-white rounded-2xl shadow-sm ring-1 ring-blue-200 overflow-hidden">
        <div class="px-4 py-3 border-b border-blue-100 flex items-center justify-between">
          <h2 class="text-sm font-semibold text-blue-700">Analyse Resultaten</h2>
          <span class="text-xs text-slate-500">Thumbnail ¬∑ beschrijving ¬∑ emotie ¬∑ doel</span>
        </div>
        <div id="resultsList" class="p-4 space-y-3 max-h-[680px] overflow-auto scroll-shadow">
          <p class="text-sm text-slate-500">Voer een analyse uit om resultaten te zien.</p>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-xs text-slate-500">
      <p>De app pauzeert de video en stapt door (0s, 5s, 10s, ‚Ä¶). Elk frame wordt via Canvas vastgelegd en naar Gemini gestuurd voor
        <strong>beschrijving</strong>, <strong>emotie</strong> en <strong>doel</strong>.</p>
    </footer>
  </div>

  <script>
    /********************** Logger *************************/
    class Logger {
      constructor(area){ this.area=area; this.buffer=[]; this.flushScheduled=false; }
      ts(){ return new Date().toISOString().replace('T',' ').replace('Z',''); }
      log(level,msg,data){ const line=`[${this.ts()}] [${level}] ${msg}${data?' '+JSON.stringify(data):''}`;
        this.buffer.push(line); if(!this.flushScheduled){ this.flushScheduled=true; queueMicrotask(()=>this.flush()); }
        if(level==='ERROR') console.error(msg,data??''); else console.debug(msg,data??'');
      }
      info(m,d){this.log('INFO',m,d)} warn(m,d){this.log('WARN',m,d)} error(m,d){this.log('ERROR',m,d)}
      flush(){ if(!this.buffer.length) return; const div=document.createElement('div'); div.textContent=this.buffer.join('\n')+'\n';
        this.area.appendChild(div); this.area.scrollTop=this.area.scrollHeight; this.buffer=[]; this.flushScheduled=false; }
      clear(){ this.area.textContent=''; this.info('Log cleared.'); }
      copy(){ const t=this.area.textContent||''; navigator.clipboard.writeText(t).then(()=>this.info('Log copied ('+t.length+' chars).'))
        .catch(err=>this.warn('Clipboard copy failed',{error:String(err)})); }
    }

    /********************** API Manager (Gemini) *************************/
    class APIManager {
      constructor({getApiKey,logger}) {
        this.getApiKey=getApiKey; this.logger=logger;
        this.model='gemini-1.5-flash-latest';
        this.base='https://generativelanguage.googleapis.com/v1beta';
        this.prompt=[
          "You are analyzing a single still video frame.",
          "Return compact JSON with keys:",
          "description: factual description (string).",
          "emotions: array of {label, confidence in [0,1]} for clearly VISIBLE human facial expressions (empty if none).",
          "purpose: short guess of the frame's purpose (e.g., establishing shot, detail/close-up, action focus, transition, title card).",
          "Constraints: Be objective. Do NOT infer identity/sensitive attributes. If no people, set emotions to []."
        ].join("\n");
      }
      async analyzeImageBase64(base64Png,{timestamp}) {
        const key=this.getApiKey(); if(!key) throw new Error('Missing API key.');
        const url=`${this.base}/models/${this.model}:generateContent?key=${encodeURIComponent(key)}`;
        const body={ contents:[{ role:'user', parts:[ {text:this.prompt}, {inline_data:{mime_type:'image/png',data:base64Png}} ] }],
                     generationConfig:{ response_mime_type:'application/json' } };
        this.logger.info('API request',{t:timestamp.toFixed(2)+'s', bytes:base64Png.length});
        const maxAttempts=4; let delay=800;
        for(let attempt=1; attempt<=maxAttempts; attempt++){
          const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
          if(res.ok){
            const json=await res.json();
            const raw=json?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\n')?.trim() ?? '';
            try{
              const parsed=JSON.parse(raw);
              return {
                description: typeof parsed?.description==='string' ? parsed.description : '(no description)',
                emotions: Array.isArray(parsed?.emotions) ? parsed.emotions : null,
                purpose: typeof parsed?.purpose==='string' ? parsed.purpose : null
              };
            }catch(_){ return { description: raw||'(no text)', emotions: null, purpose: null }; }
          }
          if(res.status===429 && attempt<maxAttempts){ this.logger.warn(`429 rate-limited; retry in ${delay}ms`,{attempt});
            await new Promise(r=>setTimeout(r,delay)); delay*=2; continue; }
          let err=`${res.status} ${res.statusText}`; try{const ej=await res.json(); err+=' ‚Äî '+(ej?.error?.message||JSON.stringify(ej));}catch(_){}
          throw new Error('Gemini API error: '+err);
        }
        throw new Error('Gemini API: max attempts exceeded.');
      }
    }

    /********************** Video Player *************************/
    class VideoPlayer {
      constructor({videoEl,canvas,onMeta,logger}){
        this.video=videoEl; this.canvas=canvas; this.ctx=canvas.getContext('2d',{willReadFrequently:true});
        this.logger=logger; this.onMeta=onMeta; this._bind();
        this._metaReadyPromise=new Promise((resolve)=>{ this._resolveMeta=resolve; });
      }
      _bind(){
        const v=this.video; const L=this.logger;
        v.addEventListener('loadedmetadata',()=>{
          L.info('Video loadedmetadata',{duration:v.duration,w:v.videoWidth,h:v.videoHeight});
          this._fitCanvas(); this.onMeta?.({duration:v.duration,width:v.videoWidth,height:v.videoHeight});
          this._resolveMeta?.(); // signal ready
        });
        ['play','pause','seeking','seeked','ended','error'].forEach(ev =>
          v.addEventListener(ev,()=>{ if(ev==='error'){ const err=v.error; this.logger.error('Video error',{code:err?.code,message:err?.message}); }
                                       else { this.logger.info('Video event',{type:ev,t:v.currentTime}); } })
        );
      }
      async ensureMetadata(){ if(this.video.readyState>=1) return; await this._metaReadyPromise; }
      loadFile(file){
        const url=URL.createObjectURL(file);
        this.video.src=url; this.video.hidden=false; this.video.load();
        this.logger.info('File selected',{name:file.name,size:file.size,type:file.type});
      }
      pause(){ if(!this.video.paused) this.video.pause(); }
      _fitCanvas(){ this.canvas.width=this.video.videoWidth||1280; this.canvas.height=this.video.videoHeight||720; }
      async seekTo(seconds){
        return new Promise((resolve,reject)=>{
          const v=this.video;
          const onSeeked=()=>{ v.removeEventListener('seeked',onSeeked); requestAnimationFrame(()=>setTimeout(resolve,20)); };
          const onError=()=>{ v.removeEventListener('seeked',onSeeked); reject(new Error('Seek error')); };
          v.addEventListener('seeked',onSeeked,{once:true}); v.addEventListener('error',onError,{once:true});
          v.currentTime=Math.min(Math.max(seconds,0), v.duration||seconds);
        });
      }
      captureFrameToDataURL(){
        this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height);
        const dataUrl=this.canvas.toDataURL('image/png');
        return { dataUrl, base64: dataUrl.split(',')[1] };
      }
    }

    /********************** Frame Analyzer *************************/
    class FrameAnalyzer {
      constructor({player,api,resultsList,status,logger}){
        this.player=player; this.api=api; this.resultsList=resultsList; this.status=status; this.logger=logger;
        this.isRunning=false; this.stepSeconds=5;
      }
      setStatus(state, step='‚Äì', progress=0){
        const styles={ ready:'bg-blue-100 text-blue-800', analyzing:'bg-amber-100 text-amber-800',
                       complete:'bg-emerald-100 text-emerald-800', error:'bg-rose-100 text-rose-800' };
        // pill color
        this.status.pill.className = this.status.pill.className
          .split(' ').filter(c=>!c.startsWith('bg-') && !c.startsWith('text-')).join(' ')
          .trim() + ' ' + styles[state];
        this.status.text.textContent=state;
        this.status.step.textContent=step;
        this.status.progress.textContent=`${Math.round(progress)}%`;
        this.status.bar.style.width = `${Math.round(progress)}%`;
      }
      clearResults(){ this.resultsList.innerHTML=''; }
      emotionChips(emotions){
        if(!Array.isArray(emotions)) return '';
        if(emotions.length===0){
          return `<span class="inline-flex items-center rounded-full bg-blue-50 text-blue-600 ring-1 ring-blue-200 px-2 py-0.5 text-[10px]">No emotions detected</span>`;
        }
        return emotions.slice(0,6).map(e=>`
          <span class="inline-flex items-center rounded-full bg-blue-50 text-blue-700 ring-1 ring-blue-200 px-2 py-0.5 text-[10px]">
            ${escapeHtml(e.label)} ¬∑ ${Number(e.confidence).toFixed(2)}
          </span>`).join(' ');
      }
      appendResult({timestamp,thumbUrl,description,emotions,purpose,error}){
        const card=document.createElement('div');
        card.className='flex gap-3 p-3 border border-blue-100 rounded-xl';
        card.innerHTML=`
          <div class="w-24 h-16 shrink-0 bg-blue-100 rounded-lg overflow-hidden ring-1 ring-blue-200">
            <img src="${thumbUrl}" alt="Frame op ${timestamp.toFixed(2)}s" class="w-full h-full object-cover"/>
          </div>
          <div class="min-w-0">
            <div class="text-xs text-slate-500 mb-1">t = ${timestamp.toFixed(2)}s</div>
            <div class="text-sm ${error ? 'text-rose-700' : 'text-slate-800'} break-words">
              ${error ? ('‚ö†Ô∏è ' + escapeHtml(description)) : escapeHtml(description)}
            </div>
            <div class="mt-1 flex flex-wrap gap-1.5">${this.emotionChips(emotions)}</div>
            ${purpose ? `<div class="mt-1 text-xs text-blue-600 italic">Doel: ${escapeHtml(purpose)}</div>` : ''}
          </div>`;
        this.resultsList.appendChild(card);
      }
      buildTimestamps(duration){
        const s=[]; for(let t=0; t<=duration; t+=this.stepSeconds) s.push(Math.min(t,duration));
        if(s.length && s[s.length-1] < duration - 0.25) s.push(duration);
        return s;
      }
      async run(){
        if(this.isRunning) return;
        this.isRunning=true;
        this.logger.info('Analysis start (5s + emotion + purpose)');
        this.setStatus('analyzing','initializing',0);
        this.clearResults();

        try{
          await this.player.ensureMetadata();       // <-- waits until metadata is ready
          this.player.pause();

          const duration=this.player.video.duration||0;
          if(!isFinite(duration) || duration<=0) throw new Error('Onbekende of nul duur. Wacht tot de video geladen is.');

          const stamps=this.buildTimestamps(duration);

          for(let i=0; i<stamps.length && this.isRunning; i++){
            const t=stamps[i];
            this.setStatus('analyzing', `${i+1}/${stamps.length} @ ${t.toFixed(2)}s`, (i/stamps.length)*100);
            this.logger.info('Seeking',{target:t});

            await this.player.seekTo(t);
            await new Promise(r=>setTimeout(r,30)); // compositor tick

            this.logger.info('Capturing frame',{t});
            const {dataUrl, base64} = this.player.captureFrameToDataURL();

            try{
              const result = await this.api.analyzeImageBase64(base64,{timestamp:t});
              this.appendResult({
                timestamp:t, thumbUrl:dataUrl,
                description: result.description || '(geen beschrijving)',
                emotions: result.emotions,            // [] -> show badge, null -> unknown
                purpose: result.purpose || null
              });
            }catch(err){
              const msg=(err && err.message)? err.message : String(err);
              this.logger.error('API analysis failed',{t,error:msg});
              this.appendResult({ timestamp:t, thumbUrl:dataUrl, description: msg, emotions: null, purpose: null, error:true });
            }
          }

          this.setStatus('complete','done',100);
          this.logger.info('Analysis finished');
        }catch(err){
          this.setStatus('error','failed',0);
          this.logger.error('Analysis crashed',{error:(err && err.message)? err.message : String(err)});
        }finally{
          this.isRunning=false;
        }
      }
      stop(){ if(!this.isRunning) return; this.logger.warn('Analysis stopped by user'); this.isRunning=false; this.setStatus('ready','stopped',0); }
    }

    /********************** Bootstrap *************************/
    (function main(){
      // Elements
      const videoEl=document.getElementById('videoEl');
      const canvasEl=document.getElementById('captureCanvas');
      const fileInput=document.getElementById('fileInput');
      const apiKeyInput=document.getElementById('apiKeyInput');
      const analyzeBtn=document.getElementById('analyzeBtn');
      const stopBtn=document.getElementById('stopBtn');
      const logArea=document.getElementById('logArea');
      const resultsList=document.getElementById('resultsList');
      const statusPill=document.getElementById('statusPill');
      const statusText=document.getElementById('statusText');
      const stepText=document.getElementById('stepText');
      const progressText=document.getElementById('progressText');
      const progressBar=document.getElementById('progressBar');
      const metaDuration=document.getElementById('metaDuration');
      const metaSize=document.getElementById('metaSize');
      const metaType=document.getElementById('metaType');
      const metaRes=document.getElementById('metaRes');
      const clearLogBtn=document.getElementById('clearLogBtn');
      const copyLogBtn=document.getElementById('copyLogBtn');

      // Tools
      const logger=new Logger(logArea);
      const player=new VideoPlayer({
        videoEl, canvas:canvasEl, logger,
        onMeta:({duration,width,height})=>{
          metaDuration.textContent=isFinite(duration)? duration.toFixed(2)+'s':'‚Äì';
          metaRes.textContent=(width&&height)? `${width}√ó${height}px`:'‚Äì';
          updateAnalyzeEnabled();
        }
      });
      const api=new APIManager({ getApiKey:()=>apiKeyInput.value.trim(), logger });
      const analyzer=new FrameAnalyzer({
        player, api, resultsList,
        status:{ pill:statusPill, text:statusText, step:stepText, progress:progressText, bar:progressBar },
        logger
      });

      // Enable/disable Start button only when ready
      function updateAnalyzeEnabled(){
        const ready = Boolean(videoEl.src) && Boolean(apiKeyInput.value.trim());
        analyzeBtn.disabled = !ready;
      }

      // UI events
      fileInput.addEventListener('change',(e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        if(!f.type.startsWith('video/')){ alert('Selecteer een geldig videobestand.'); return; }
        player.loadFile(f);
        metaType.textContent=f.type||'‚Äì';
        metaSize.textContent=f.size? prettyBytes(f.size) : '‚Äì';
        analyzer.setStatus('ready','loaded',0);
        updateAnalyzeEnabled();
      });
      apiKeyInput.addEventListener('input', updateAnalyzeEnabled);

      analyzeBtn.addEventListener('click', async ()=>{
        if(analyzeBtn.disabled) return;
        analyzeBtn.disabled = true; stopBtn.disabled = false;
        await analyzer.run();
        analyzeBtn.disabled = false; stopBtn.disabled = true;
      });

      stopBtn.addEventListener('click', ()=>{ analyzer.stop(); analyzeBtn.disabled=false; stopBtn.disabled=true; });

      clearLogBtn.addEventListener('click',()=>logger.clear());
      copyLogBtn.addEventListener('click',()=>logger.copy());

      // Extra logs
      videoEl.addEventListener('play',()=>logger.info('Playback started'));
      videoEl.addEventListener('pause',()=>logger.info('Playback paused'));

      // Helpers
      function prettyBytes(bytes){
        if(!isFinite(bytes)) return '‚Äì';
        const u=['B','KB','MB','GB','TB']; let i=0,n=bytes;
        while(n>=1024 && i<u.length-1){ n/=1024; i++; }
        return `${n.toFixed(1)} ${u[i]}`;
      }
      window.escapeHtml=function(str){
        return String(str).replace(/[&<>"'`=\/]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;','=':'&#61;','/':'&#47;'}[s]));
      };

      // Initial state
      analyzer.setStatus('ready','idle',0);
      logger.info('App ready (5s interval + emotion + purpose)');
      logger.info('Tip', {text:'Als het niet start: wacht tot ‚ÄúDuur‚Äù is ingevuld en zorg dat de API key staat ingevuld. Dan wordt de Start-knop actief.'});
    })();
  </script>
</body>
</html>
